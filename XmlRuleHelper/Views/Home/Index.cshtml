@{
    ViewBag.Title = "Home Page";
    Layout = "~/Views/Shared/_Layout.cshtml";


    <form class="container pt-4">
        <div class="row">
            <div class="form-group col-md-6">
                <label for="inputElement">加入類別</label>
                <select id="inputType" class="form-control">
                    <option value="ALIAS">別名</option>
                    <option value="CONDITION">條件</option>
                </select>
            </div>
            <div class="form-group col-md-6">
                <label for="inputElement"></label>
                @*<input type="text" class="form-control" id="inputGroupName">*@
            </div>
        </div>

        <div class="row">
            <div class="form-group col-md-6">
                <label for="inputElement">元件</label>
                @Html.DropDownList("inputElement", (IEnumerable<SelectListItem>)ViewData["inputElement"], new { @class = "form-control" })
            </div>
            <div class="form-group col-md-6">
                <label for="inputAttribute">元件屬性</label>
                <select id="inputAttribute" class="form-control">
                    <option selected></option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="form-group col-md-6">
                <label for="inputMethod">篩選條件</label>
                <select id="inputMethod" class="form-control">
                    <option value="StartWith">開頭包含</option>
                    <option value="EndWith">結尾包含</option>
                    <option value="Contain">包含</option>
                    <option value="Between">介於</option>
                    <option value="Equal">等於</option>
                    <option value="NotEqual">不等於</option>
                    <option value="NotEqual">大於等於</option>
                    <option value="NotEqual">小於等於</option>
                </select>
            </div>
            <div class="form-group col-md-6">
                <label for="inputMethodText">篩選條件參數</label>
                <input type="text" class="form-control" id="inputMethodText">
            </div>
        </div>

        <div class="row">
            <div class="form-group col-md-6">
                <label for="inputOperator">運算子</label>
                <select id="inputOperator" class="form-control">
                    <option value="And">And</option>
                    <option value="Or">Or</option>
                </select>
            </div>
        </div>


        <button class="btn btn-md btn-primary" id="btnAddRow" type="button"> Add new Row</button>
        <button type="submit" class="btn btn-primary">Sign in</button>
    </form>

    <br>
    <h>Set ALIAS</h>
    <div class="container pt-4">
        <div class="aliasdiv table-responsive">
            @*<table class="table table-bordered">
                <thead>
                    <tr>
                        <th class="text-center">inputOperator</th>
                        <th class="text-center">inputElement</th>
                        <th class="text-center">inputAttribute</th>
                        <th class="text-center">inputMethod</th>
                        <th class="text-center">inputMethodText</th>
                        <th class="text-center">HeadGroupName</th>
                        <th class="text-center">resultName</th>
                        <th class="text-center">Remove Row</th>
                        <th class="text-center">Add SubRow</th>
                    </tr>
                </thead>
                <tbody id="tbodyHead">
                </tbody>
            </table>*@
        </div>
    </div>

    <h>FOOT TABLE</h>
    <div class="container pt-4">
        <div class=" table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th class="text-center">inputOperator</th>
                        <th class="text-center">inputElement</th>
                        <th class="text-center">inputAttribute</th>
                        <th class="text-center">inputMethod</th>
                        <th class="text-center">inputMethodText</th>
                        <th class="text-center">resultName</th>
                        <th class="text-center">Remove Row</th>
                        <th class="text-center">Add SubRow</th>
                    </tr>
                </thead>
                <tbody id="tbodyFoot">
                </tbody>
            </table>
        </div>
    </div>
}

@section Scripts{
    <script>
        var RoleRowIdTitle = 'oForm_tableRoles_Row_';
        var footRowIdTitle = 'oForm_tableRules_footRow_';
        const aryHeadGroupName = [];

        $(document).ready(function () {
            //row expand key word => data-toggle="collapse", <a data-toggle="collapse" href="#collapseExample">+</a>
            ChangeAttributeReplaceWith();            
            var headRowIndex = 0;
            var footRowIndex = 0;

            $('#btnAddRow').on('click', function () {                
                var type = $('#inputType').val();
                if (type == "ALIAS") {
                    headRowIndex++;
                    var trId = RoleRowIdTitle + headRowIndex
                    $('.aliasdiv').append(aliasAppend(trId, 'M'));
                    setFirstTd(trId);
                }
                else {
                    footRowIndex++;
                    var trId = footRowIdTitle + footRowIndex
                    $('#tbodyFoot').append('<tr id=' + trId + '><td class="text-center">' + $("#inputOperator").val() + '</td><td class="text-center tdSelGroupName">' + getHeadGroupName() + '</td><td class="text-center">' + $("#inputAttribute").val() + '</td><td class="text-center">' + $("#inputMethod option:selected").text() + '</td><td class="text-center">' + $("#inputMethodText").val() + '</td><td><input type="text"></input></td><td class="text-center"><button class="btn btn-danger remove" type="button">Remove</button><td class="text-center"><button class="btn btn-info addSubRow" type="button">AddSubRow</button></td></tr>');
                }                
            });

            $('.aliasdiv').on('click', '.remove', function () {
                if (!$(this).closest('tr').hasClass('subrow'))
                {// 移除主Row
                    var currentTrId = $(this).closest('tr').attr('id')
                    var subRows = getSubRow(currentTrId);
                    subRows.each(function () {
                        $(this).closest('tr').remove();
                    })

                    /* 重新設定ID */
                    var child = $(this).closest('tr').nextAll().not(".subrow")
                    child.each(function () {
                        var id = $(this).attr('id');
                        var dig = parseInt(id.substring(21));

                        // Modifying row index.
                        //idx.html(`${dig - 1}`);

                        // Modifying row id.
                        renameSubRow2(id, `${RoleRowIdTitle}${dig - 1}`);
                        $(this).attr('id', `${RoleRowIdTitle}${dig - 1}`);
                    });

                    //Head刪除主Row後，有相依的Foot Row也要一併刪除
                    var alias = $(this).closest('tr').find('td[class*="alias"]').html();
                    if (alias.length > 0) {
                        $('#tbodyFoot').find('tr td[class*="tdSelGroupName"] select').each(function () {
                            if ($(this).val() == alias) {
                                $('#tbodyFoot').find('tr button[class*="remove"]').click();
                            }
                        })
                        //移除下拉選單對應的GroupName
                        updateSelectGroupName("R", alias);
                    }
                    $(this).closest('table').remove();

                    headRowIndex--;
                }
                else
                {//移除次Row
                    var id = $(this).closest('tr').attr('id');
                    var idSplit = id.split('_');
                    $(this).closest('tr').remove();
                    var parentId = idSplit[0] + '_' + idSplit[1] + '_' + idSplit[2] + '_'+ idSplit[3]
                    renameSubRow(parentId);
                }


                setFirstTd();
            });
            $('.aliasdiv').on('click', '.addSubRow', function () {
                var parentRowId = $(this).closest('tr').attr('id');
                $('#' + parentRowId).after(aliasAppend(parentRowId, 'D'))
                renameSubRow(parentRowId)
            });
            $('.aliasdiv').on('click', '.setAlias', function () {
                if (confirm('別名設定後無法變更\n\n請確認！') == true) {
                    var inputAlias = $(this).closest('tr').find('td[class*="alias"] input').val().trim();
                    //加入源頭條件群組名稱至下拉選單
                    if (inputAlias.length > 0) {
                        /*新增下拉選單選項*/
                        updateSelectGroupName("A", inputAlias)
                        //確認別名後，無法再進行異動
                        $(this).closest('tbody').find('td[class*="alias"] input').attr('disabled', true);
                        $(this).closest('tbody').find('button[class*="setAlias"]').attr('disabled', true);
                        $(this).closest('tbody').find('button[class*="remove"]').attr('disabled', true);
                        $(this).closest('tbody').find('button[class*="addSubRow"]').attr('disabled', true);
                        //變更<tbody> ID
                        $(this).closest('tr').parent('tbody').attr('id', 'tbody_' + inputAlias);
                    }  
                } else {
                    return ;
                }            
            })
            
            $('#tbodyFoot').on('click', '.remove', function () {
                if (!$(this).closest('tr').hasClass('subrow')) {// 移除主Row
                    var currentTrId = $(this).closest('tr').attr('id')
                    var subRows = getSubRow(currentTrId);
                    subRows.each(function () {
                        $(this).closest('tr').remove();
                    })

                    /* 重新設定ID */
                    var child = $(this).closest('tr').nextAll().not(".subrow")
                    child.each(function () {
                        var id = $(this).attr('id');
                        var dig = parseInt(id.substring(21));

                        // Modifying row index.
                        //idx.html(`${dig - 1}`);

                        // Modifying row id.
                        renameSubRow2(id, `${footRowIdTitle}${dig - 1}`);
                        $(this).attr('id', `${footRowIdTitle}${dig - 1}`);
                    });

                    $(this).closest('tr').remove();

                    footRowIndex--;
                }
                else {
                    var id = $(this).closest('tr').attr('id');
                    var idSplit = id.split('_');
                    $(this).closest('tr').remove();
                    var parentId = idSplit[0] + '_' + idSplit[1] + '_' + idSplit[2] + '_' + idSplit[3]
                    renameSubRow(parentId);
                }


                //setFirstTd();
            });
            $('#tbodyFoot').on('click', '.addSubRow', function () {
                var parentRowId = $(this).closest('tr').attr('id');

                $('#' + parentRowId).after('<tr class = "subrow" id=' + parentRowId + '_SubRow' + '><td class="text-center">' + $("#inputOperator").val() + '</td><td class="text-center tdSelGroupName">' + getHeadGroupName() + '</td>><td class="text-center">' + $("#inputAttribute").val() + '</td><td class="text-center">' + $("#inputMethod option:selected").text() + '</td><td class="text-center">' + $("#inputMethodText").val() + '</td><td></td><td class="text-center"><button class="btn btn-danger remove" type="button">Remove</button></td><td></td></tr>');
                renameSubRow(parentRowId)
            });
            $('#tbodyFoot').on('change', '.selGroupName', function () {
                var sel = $(this).closest('tr').find('td[class*="tdSelGroupName"] select');
                sel.attr("headGroupName", sel.val());
            })
        })

        function ChangeAttributeReplaceWith() {
                $.ajax(
                    {
                        url: "@Url.Action("GetAttributeData", "Home")",
                        data: { /*element: inputElement*/ },
                        type: 'post',
                        cache: false,
                        async: false,
                        dataType: 'html',
                        success: function (data) {
                            if (data.length > 0) {
                                $('#inputAttribute').replaceWith(data);
                            }
                        }
                    });
        }

        function setFirstTd(title) {
            //Table的第一個Row的運算子要拿掉
            $("#" + title).find("td:first").html("");
        }

        function getSubRow(parentRowId) {
            return $('tr[id^="' + parentRowId + '"]').filter('.subrow');
        }

        function renameSubRow(parentRowId) {
            var idx = 0;
            var subRows = getSubRow(parentRowId);
            subRows.each(function () {
                idx++;
                $(this).attr('id', `${parentRowId}_${idx}`);
            });
        }

        function renameSubRow2(parentRowId, newParentRowId) {
            var idx = 0;
            var subRows = getSubRow(parentRowId);
            subRows.each(function () {
                idx++;
                $(this).attr('id', `${newParentRowId}_${idx}`);
            });
        }

        function getHeadGroupName() {
            var res = '';
            if (aryHeadGroupName.length > 0) {
                res += '<select class="selGroupName">'
                for (var i = 0; i < aryHeadGroupName.length; i++) {

                    res += '<option>' + aryHeadGroupName[i].value + '</Option >'
                }
                res += '</select>'
            }
            return res;
        }

        function updateSelectGroupName(type, alias) {
            if (type == "A") {
                var arraycontainsturtles = (aryHeadGroupName.indexOf("aa") > -1);
                for (var i = 0; i < aryHeadGroupName.length; i++) {
                    if (aryHeadGroupName[i].value == alias) {
                        alert("別名重複!!!");
                        return;
                    }
                }

                aryHeadGroupName.push({
                    key: alias,
                    value: alias
                });
            }
            else if (type == "R") {
                for (var i = 0; i < aryHeadGroupName.length; i++) {
                    if (aryHeadGroupName[i].value == alias) {
                        aryHeadGroupName.splice(i, 1)
                    }
                }
            }

            $('.selGroupName').replaceWith(getHeadGroupName());
        }

        function aliasAppend(trId, type) {
            var thead = '<table class="table table-bordered">\
                <thead>\
                    <tr>\
                        <th class="text-center">inputOperator</th>\
                        <th class="text-center">inputElement</th>\
                        <th class="text-center">inputAttribute</th>\
                        <th class="text-center">inputMethod</th>\
                        <th class="text-center">inputMethodText</th>\
                        <th class="text-center">alias</th>\
                        <th class="text-center">setAlias</th>\
                        <th class="text-center">Remove Row</th>\
                        <th class="text-center">Add SubRow</th>\
                    </tr>\
                </thead>\
                <tbody>' 

            var tr = ''
            if (type == "M") {
                tr = '\
                <tr id = ' + trId + ' >\
                <td class="text-center">' + $("#inputOperator").val() + '</td>\
                <td class="text-center">' + $("#inputElement").val() + '</td>\
                <td class="text-center">' + $("#inputAttribute").val() + '</td>\
                <td class="text-center">' + $("#inputMethod option:selected").text() + '</td>\
                <td class="text-center">' + $("#inputMethodText").val() + '</td>\
                <td class="text-center alias"><input></input></td>\
                <td class="text-center" ><button class="btn btn-info setAlias" type="button">SetAlias</button></td >\
                <td class="text-center" > <button class="btn btn-danger remove" type="button">Remove</button></td>\
                <td class="text-center"><button class="btn btn-info addSubRow" type="button">AddSubRow</button></td>\
                </tr></tbody></table>';

                return thead + tr
            }
            else {
                tr = '\
                <tr class = "subrow" id=' + trId + '_SubRow' + '>\
                <td class="text-center" > ' + $("#inputOperator").val() + '</td>\
                <td class="text-center tdSelGroupName" > ' + getHeadGroupName() + '</td >\
                <td class="text-center">' + $("#inputAttribute").val() + '</td>\
                <td class="text-center">' + $("#inputMethod option:selected").text() + '</td>\
                <td class="text-center">' + $("#inputMethodText").val() + '</td>\
                <td></td>\
                <td></td>\
                <td class="text-center"><button class="btn btn-danger remove" type="button">Remove</button></td>\
                <td class="text-center"><button class="btn btn-info addSubRow" type="button">AddSubRow</button></td>\
                </tr>';

                return tr;
            }
        }

        function getOption_Type() {
            var datas = '{"type": "getOption_Type"}';//'{"type": "getOption_Type","lineId":"1"}';
            var action = projectName + "Combobox/CommonQuery";
            $.ajax({
                url: action,
                type: "POST",
                cache: false,
                async: false,
                data: { data: datas },
                error: function (xhr) { },
                success: function (res) {
                    res = $('<div/>').html(res.replace(/\n/g, "")).text();
                    $("#allData").val(res);
                }
            });
        }


    </script>
}